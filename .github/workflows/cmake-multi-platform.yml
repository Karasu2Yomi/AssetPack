name: CMake (MinGW-w64)

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:
  workflow_dispatch:

permissions:
  contents: write   # GitHub Release 作成/更新
  packages: write   # GitHub Packages (NuGet) 公開

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        build_type: [Debug, Release]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # MSYS2 + MinGW-w64 toolchain
      - name: Setup MSYS2 (MINGW64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          cache: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-binutils
            git

      # Configure
      - name: Configure
        shell: msys2 {0}
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DASSETPACK_BUILD_TESTS=ON \
            -DASSETPACK_COPY_RUNTIME_DLLS=OFF

      # Build
      - name: Build
        shell: msys2 {0}
        run: |
          cmake --build build -j 10

      # Test（テスト未作成でもCIを落とさない）
      - name: Test (ctest)
        shell: msys2 {0}
        run: |
          ctest --test-dir build --output-on-failure --no-tests=ignore

      # （デバッグ用）出力確認
      - name: List build outputs
        shell: msys2 {0}
        run: |
          echo "=== build/bin ==="
          ls -la build/bin || true
          echo "=== build files (top 200) ==="
          find build -maxdepth 4 -type f | sort | head -n 200 || true

      # 実行に必要なファイルを dist に集約（Debug/Release 両方）
      # MinGW では ldd ベースで DLL を拾う方が安定
      - name: Collect runtime files
        shell: msys2 {0}
        run: |
          set -e

          EXE="build/bin/AssetPack-LUO_JIEWEN.exe"
          if [ ! -f "$EXE" ]; then
            echo "ERROR: $EXE not found"
            exit 1
          fi

          mkdir -p dist
          cp "$EXE" dist/

          # ldd から依存 DLL を抽出
          # 例:
          #   libstdc++-6.dll => /mingw64/bin/libstdc++-6.dll (...)
          #   /mingw64/bin/SDL3.dll (...)
          # Windows system DLL は除外
          ldd "$EXE" | tr -d '\r' | awk '
            {
              p=""
              # pattern 1: xxx.dll => /path/to/xxx.dll
              if ($0 ~ /=>/ && $3 ~ /\.dll$/) {
                p=$3
              }
              # pattern 2: /path/to/xxx.dll (direct)
              else if ($1 ~ /^\/.*\.dll$/) {
                p=$1
              }

              if (p != "") {
                low=p
                # Windows system DLL は除外（同梱しない）
                if (low ~ /^\/[a-z]\/windows\// || low ~ /^\/[a-z]\/Windows\//) next
                print p
              }
            }
          ' | sort -u > dlls.txt

          echo "=== DLLs from ldd ==="
          cat dlls.txt || true

          while IFS= read -r f; do
            if [ -f "$f" ]; then
              cp -f "$f" dist/
            fi
          done < dlls.txt

          echo "=== dist contents ==="
          ls -la dist

      # CI用 Artifact（Debug/Release 両方）
      # 重要: exe単体ではなく dist 丸ごと
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AssetPack-LUO_JIEWEN-${{ matrix.build_type }}
          path: dist/*
          if-no-files-found: error
          retention-days: 14

      # -----------------------------
      # ここから下は Release ビルド + タグ push 時のみ
      # -----------------------------

      - name: Zip release package
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          $zipName = "AssetPack-LUO_JIEWEN-${{ github.ref_name }}-win64-mingw.zip"
          if (Test-Path $zipName) { Remove-Item $zipName -Force }
          Compress-Archive -Path dist\* -DestinationPath $zipName -Force
          Write-Host "Created: $zipName"

      - name: Create or Update GitHub Release
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "${{ github.ref_name }}"
          $asset = "AssetPack-LUO_JIEWEN-${{ github.ref_name }}-win64-mingw.zip"

          gh release view $tag *> $null
          if ($LASTEXITCODE -ne 0) {
            gh release create $tag $asset --title $tag --generate-notes
          } else {
            gh release upload $tag $asset --clobber
          }

      # -----------------------------
      # GitHub Packages (NuGet)
      # -----------------------------
      - name: Setup NuGet
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        uses: NuGet/setup-nuget@v2

      - name: Create nuspec
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          @"
          <?xml version="1.0"?>
          <package>
            <metadata>
              <id>AssetPack.LUO_JIEWEN</id>
              <version>0.0.0</version>
              <authors>${{ github.repository_owner }}</authors>
              <owners>${{ github.repository_owner }}</owners>
              <requireLicenseAcceptance>false</requireLicenseAcceptance>
              <description>AssetPack tool (MinGW build)</description>
              <repository type="git" url="https://github.com/${{ github.repository }}" />
              <tags>cpp mingw tool</tags>
            </metadata>
            <files>
              <file src="dist\**\*.*" target="tools" />
            </files>
          </package>
          "@ | Set-Content AssetPack.LUO_JIEWEN.nuspec -Encoding UTF8

      - name: Pack NuGet
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          $ver = "${{ github.ref_name }}"
          if ($ver.StartsWith("v")) { $ver = $ver.Substring(1) }

          (Get-Content AssetPack.LUO_JIEWEN.nuspec) `
            -replace '<version>.*</version>', "<version>$ver</version>" `
            | Set-Content AssetPack.LUO_JIEWEN.nuspec -Encoding UTF8

          nuget pack AssetPack.LUO_JIEWEN.nuspec `
            -NoPackageAnalysis `
            -OutputDirectory nupkg `
            -NonInteractive

          Get-ChildItem nupkg

      - name: Publish to GitHub Packages (NuGet)
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          # 既に同名 source がある場合に備えて削除（再実行でも失敗しにくくする）
          nuget sources Remove -Name github | Out-Null
          if ($LASTEXITCODE -ne 0) { $LASTEXITCODE = 0 }

          nuget sources Add `
            -Name github `
            -Source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" `
            -Username "${{ github.repository_owner }}" `
            -Password "${{ secrets.GITHUB_TOKEN }}" `
            -StorePasswordInClearText

          Get-ChildItem nupkg\*.nupkg | ForEach-Object {
            nuget push $_.FullName `
              -Source github `
              -ApiKey "${{ secrets.GITHUB_TOKEN }}" `
              -SkipDuplicate `
              -NonInteractive
          }