name: CMake (MinGW-w64)

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        build_type: [Debug, Release]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # MSYS2 + MinGW-w64 toolchain
      - name: Setup MSYS2 (MINGW64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          cache: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-pkg-config
            git

      # Configure
      - name: Configure
        shell: msys2 {0}
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DASSETPACK_BUILD_TESTS=ON

      # Build
      - name: Build
        shell: msys2 {0}
        run: |
          cmake --build build -j 10

      # Test（テストが無い場合はそのまま継続）
      - name: Test (ctest)
        shell: msys2 {0}
        run: |
          ctest --test-dir build --output-on-failure || true

      # exe の実際の出力先を検索して固定場所に集約
      - name: Locate built exe
        shell: msys2 {0}
        run: |
          set -e

          APP_EXE_NAME="AssetPack-LUO_JIEWEN.exe"

          mkdir -p ci_out

          EXE_PATH=$(find build -type f -name "$APP_EXE_NAME" | head -n 1)

          if [ -z "$EXE_PATH" ]; then
            echo "ERROR: $APP_EXE_NAME not found under build/"
            echo "---- files in build/ ----"
            find build -maxdepth 6 -type f | sort
            exit 1
          fi

          echo "Found exe: $EXE_PATH"
          cp "$EXE_PATH" "ci_out/$APP_EXE_NAME"

      # CI 用 Artifact（Debug/Release 両方）
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AssetPack-LUO_JIEWEN-${{ matrix.build_type }}
          path: ci_out/AssetPack-LUO_JIEWEN.exe
          if-no-files-found: error
          retention-days: 14

      # -----------------------------
      # ここから下は Release ビルドのみ
      # -----------------------------
      - name: Collect runtime files
        if: matrix.build_type == 'Release'
        shell: msys2 {0}
        run: |
          set -e
          mkdir -p dist
          cp ci_out/AssetPack-LUO_JIEWEN.exe dist/

          # MinGW runtime DLL（必要に応じて追加）
          for f in libstdc++-6.dll libgcc_s_seh-1.dll libwinpthread-1.dll; do
            if [ -f /mingw64/bin/$f ]; then
              cp /mingw64/bin/$f dist/
            fi
          done

      # タグ push の時だけ zip 作成
      - name: Zip release package
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          $zipName = "AssetPack-LUO_JIEWEN-${{ github.ref_name }}-win64-mingw.zip"
          if (Test-Path $zipName) { Remove-Item $zipName -Force }
          Compress-Archive -Path dist\* -DestinationPath $zipName -Force

      # タグ push の時だけ GitHub Release を作成/更新
      - name: Create or Update GitHub Release
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "${{ github.ref_name }}"
          $asset = "AssetPack-LUO_JIEWEN-${{ github.ref_name }}-win64-mingw.zip"

          gh release view $tag *> $null
          if ($LASTEXITCODE -ne 0) {
            gh release create $tag $asset --title $tag --generate-notes
          } else {
            gh release upload $tag $asset --clobber
          }

      # -----------------------------
      # GitHub Packages (NuGet)
      # -----------------------------
      - name: Setup NuGet
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        uses: NuGet/setup-nuget@v2

      - name: Create nuspec
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          @"
          <?xml version="1.0"?>
          <package>
            <metadata>
              <id>AssetPack.LUO_JIEWEN</id>
              <version>0.0.0</version>
              <authors>${{ github.repository_owner }}</authors>
              <owners>${{ github.repository_owner }}</owners>
              <requireLicenseAcceptance>false</requireLicenseAcceptance>
              <description>AssetPack tool (MinGW build)</description>
              <repository type="git" url="https://github.com/${{ github.repository }}" />
              <tags>cpp mingw tool</tags>
            </metadata>
            <files>
              <file src="dist\**\*.*" target="tools" />
            </files>
          </package>
          "@ | Set-Content AssetPack.LUO_JIEWEN.nuspec -Encoding UTF8

      - name: Pack NuGet
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          $ver = "${{ github.ref_name }}"
          if ($ver.StartsWith("v")) { $ver = $ver.Substring(1) }

          (Get-Content AssetPack.LUO_JIEWEN.nuspec) `
            -replace '<version>.*</version>', "<version>$ver</version>" `
            | Set-Content AssetPack.LUO_JIEWEN.nuspec -Encoding UTF8

          nuget pack AssetPack.LUO_JIEWEN.nuspec `
            -NoPackageAnalysis `
            -OutputDirectory nupkg `
            -NonInteractive

      - name: Publish to GitHub Packages (NuGet)
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          nuget sources Add `
            -Name github `
            -Source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" `
            -Username "${{ github.repository_owner }}" `
            -Password "${{ secrets.GITHUB_TOKEN }}" `
            -StorePasswordInClearText `
            -ConfigFile nuget.config

          nuget push "nupkg\*.nupkg" `
            -Source github `
            -ApiKey "${{ secrets.GITHUB_TOKEN }}" `
            -SkipDuplicate `
            -ConfigFile nuget.config `
            -NonInteractive
