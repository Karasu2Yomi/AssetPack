name: CMake (MinGW-w64)

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        build_type: [Debug, Release]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSYS2 (MINGW64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          cache: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-pkg-config
            git

      - name: Configure
        shell: msys2 {0}
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DASSETPACK_BUILD_TESTS=ON \
            -DASSETPACK_COPY_RUNTIME_DLLS=ON

      - name: Build
        shell: msys2 {0}
        run: |
          cmake --build build -j 10

      - name: Test (ctest)
        shell: msys2 {0}
        run: |
          ctest --test-dir build --output-on-failure --no-tests=ignore

      # 実行に必要なファイルを dist に集約（Debug/Release 両方）
      - name: Collect runtime files
        shell: msys2 {0}
        run: |
          set -e
          mkdir -p dist

          # exe
          cp build/bin/AssetPack-LUO_JIEWEN.exe dist/

          # CMake (TARGET_RUNTIME_DLLS) が build/bin にコピーした DLL 群（SDL3.dll, SDL3_image.dll など）
          cp -f build/bin/*.dll dist/ 2>/dev/null || true

          # MinGW runtime DLL（保険: これがないと今回のようなエラーになりやすい）
          for f in libstdc++-6.dll libgcc_s_seh-1.dll libwinpthread-1.dll; do
            if [ -f /mingw64/bin/$f ]; then
              cp /mingw64/bin/$f dist/
            fi
          done

          echo "=== dist contents ==="
          ls -la dist

      # Artifact には dist を丸ごと入れる（exe単体はNG）
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AssetPack-LUO_JIEWEN-${{ matrix.build_type }}
          path: dist/*
          if-no-files-found: error
          retention-days: 14

      # タグ時のみ zip（Release 用）
      - name: Zip release package
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          $zipName = "AssetPack-LUO_JIEWEN-${{ github.ref_name }}-win64-mingw.zip"
          if (Test-Path $zipName) { Remove-Item $zipName -Force }
          Compress-Archive -Path dist\* -DestinationPath $zipName -Force

      - name: Create or Update GitHub Release
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "${{ github.ref_name }}"
          $asset = "AssetPack-LUO_JIEWEN-${{ github.ref_name }}-win64-mingw.zip"

          gh release view $tag *> $null
          if ($LASTEXITCODE -ne 0) {
            gh release create $tag $asset --title $tag --generate-notes
          } else {
            gh release upload $tag $asset --clobber
          }

      # NuGet (Packages)
      - name: Setup NuGet
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        uses: NuGet/setup-nuget@v2

      - name: Create nuspec
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          @"
          <?xml version="1.0"?>
          <package>
            <metadata>
              <id>AssetPack.LUO_JIEWEN</id>
              <version>0.0.0</version>
              <authors>${{ github.repository_owner }}</authors>
              <owners>${{ github.repository_owner }}</owners>
              <requireLicenseAcceptance>false</requireLicenseAcceptance>
              <description>AssetPack tool (MinGW build)</description>
              <repository type="git" url="https://github.com/${{ github.repository }}" />
              <tags>cpp mingw tool</tags>
            </metadata>
            <files>
              <file src="dist\**\*.*" target="tools" />
            </files>
          </package>
          "@ | Set-Content AssetPack.LUO_JIEWEN.nuspec -Encoding UTF8

      - name: Pack NuGet
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          $ver = "${{ github.ref_name }}"
          if ($ver.StartsWith("v")) { $ver = $ver.Substring(1) }

          (Get-Content AssetPack.LUO_JIEWEN.nuspec) `
            -replace '<version>.*</version>', "<version>$ver</version>" `
            | Set-Content AssetPack.LUO_JIEWEN.nuspec -Encoding UTF8

          nuget pack AssetPack.LUO_JIEWEN.nuspec `
            -NoPackageAnalysis `
            -OutputDirectory nupkg `
            -NonInteractive

      - name: Publish to GitHub Packages (NuGet)
        if: matrix.build_type == 'Release' && startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          nuget sources Add `
            -Name github `
            -Source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" `
            -Username "${{ github.repository_owner }}" `
            -Password "${{ secrets.GITHUB_TOKEN }}" `
            -StorePasswordInClearText `
            -ConfigFile nuget.config

          nuget push "nupkg\*.nupkg" `
            -Source github `
            -ApiKey "${{ secrets.GITHUB_TOKEN }}" `
            -SkipDuplicate `
            -ConfigFile nuget.config `
            -NonInteractive